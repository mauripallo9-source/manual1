<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor y Control Térmico IoT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .glass-panel {
            background: rgba(30,41,59,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">

    <div class="fixed inset-0 bg-slate-900/80 pointer-events-none"></div>

    <div class="relative z-10 max-w-md mx-auto p-4 min-h-screen flex flex-col">

        <header class="flex justify-between items-center py-6">
            <div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
                    Monitor y Control
                </h1>
                <p class="text-xs text-slate-400">Sistema de Sensores y Actuadores IoT</p>
            </div>

            <button onclick="openConfig()" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600">
                <i data-lucide="settings" class="w-5 h-5 text-slate-300"></i>
            </button>
        </header>

        <div id="statusIndicator" class="mb-8 flex items-center gap-3 bg-red-500/10 border border-red-500/20 p-3 rounded-lg">
            <span class="relative flex h-3 w-3">
                <span class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 animate-ping"></span>
                <span class="relative inline-flex h-3 w-3 rounded-full bg-red-500"></span>
            </span>
            <span class="text-sm font-medium text-red-400">Desconectado de Firebase</span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            
            <div class="glass-panel p-4 rounded-xl text-center">
                <i data-lucide="thermometer" class="w-6 h-6 text-cyan-400 mx-auto mb-1"></i>
                <p class="text-xs text-slate-400">Temp. Promedio</p>
                <p id="tempPromedio" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400">--°C</p>
            </div>

            <div class="glass-panel p-4 rounded-xl flex flex-col justify-center">
                <label for="controlMode" class="block text-xs text-slate-400 font-medium mb-1">Modo de Control</label>
                <select id="controlMode" onchange="handleModeChange(this.value)" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-sm font-semibold text-white cursor-pointer">
                    <option value="automatico">Automático</option>
                    <option value="manual">Manual</option>
                </select>
                <div id="modeStatus" class="mt-2 text-center text-xs font-bold uppercase text-emerald-400">
                    </div>
            </div>
        </div>

        <div id="manualControlSection" class="glass-panel p-5 rounded-2xl mb-6 space-y-4 hidden">
            <h2 class="text-xl font-bold text-blue-300 flex items-center gap-2">
                <i data-lucide="wrench" class="w-5 h-5"></i> Control Manual
            </h2>
            <p class="text-xs text-slate-400">Requiere conexión activa. Contraseña ya ingresada.</p>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col items-center p-3 bg-slate-800 rounded-lg border border-slate-700">
                    <h4 class="font-semibold mb-2">Actuador 1</h4>
                    <button id="btnActuador1" onclick="toggleActuador(1)" class="w-full py-2 rounded-lg font-bold text-slate-100 bg-red-600 hover:bg-red-700 transition duration-150" disabled>
                        Apagar
                    </button>
                    <div id="statusActuador1" class="mt-2 text-xs font-bold text-red-400">Apagado</div>
                </div>

                <div class="flex flex-col items-center p-3 bg-slate-800 rounded-lg border border-slate-700">
                    <h4 class="font-semibold mb-2">Actuador 2</h4>
                    <button id="btnActuador2" onclick="toggleActuador(2)" class="w-full py-2 rounded-lg font-bold text-slate-100 bg-red-600 hover:bg-red-700 transition duration-150" disabled>
                        Apagar
                    </button>
                    <div id="statusActuador2" class="mt-2 text-xs font-bold text-red-400">Apagado</div>
                </div>
            </div>
        </div>

        <main class="space-y-4 flex-grow">
            <script>
                const sensors = [
                    { id:"temp1", name:"Sensor 1", color:"red" },
                    { id:"temp2", name:"Sensor 2", color:"orange" },
                    { id:"temp3", name:"Sensor 3", color:"yellow" },
                    { id:"temp4", name:"Sensor 4", color:"green" }
                ];
                // Definición de actuadores para la UI y la lógica
                const actuators = [
                    { id: "actuador1", name: "Actuador 1", ref: "actuador1" },
                    { id: "actuador2", name: "Actuador 2", ref: "actuador2" },
                ];
            </script>

            <div id="sensorList"></div>

            <script>
                const container = document.getElementById("sensorList");
                sensors.forEach(s => {
                    container.innerHTML += `
                    <div class="glass-panel p-5 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-${s.color}-500/20 rounded-lg">
                                    <i data-lucide="thermometer-sun" class="w-5 h-5 text-${s.color}-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">${s.name}</h3>
                                    <span class="text-xs text-slate-400 font-mono">/sensores/${s.id}</span>
                                </div>
                            </div>
                            <p id="${s.id}" class="text-2xl font-bold text-${s.color}-400">--°C</p>
                        </div>
                    </div>`;
                });
            </script>
        </main>

        <footer class="mt-8 text-center text-xs text-slate-500">IST Vida Nueva - Investigación</footer>
    </div>

    <div id="configModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-11/12 max-w-md">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i data-lucide="database" class="w-5 h-5 text-blue-400"></i>
                Configuración Firebase
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold">API KEY</label>
                    <input id="apiKeyInput" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3">
                </div>

                <div>
                    <label class="block text-xs font-bold">DATABASE URL</label>
                    <input id="dbUrlInput" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3">
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="closeConfig()" id="btnCancelar" class="flex-1 py-3 text-slate-300">Cancelar</button>
                <button onclick="saveConfig()" class="flex-1 bg-blue-600 py-3 rounded-xl text-white font-bold">Guardar y Conectar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let db = null;
        let isConnected = false;
        let currentMode = "automatico"; // Estado local del modo de control
        const MANUAL_PASSWORD = "123"; // Contraseña de ejemplo
        const dbPath = "dispositivo_iot"; // Raíz de la base de datos para control

        // Referencias a elementos
        const controlModeSelect = document.getElementById("controlMode");
        const manualControlSection = document.getElementById("manualControlSection");
        const modeStatus = document.getElementById("modeStatus");
        const btnActuador1 = document.getElementById("btnActuador1");
        const btnActuador2 = document.getElementById("btnActuador2");
        const statusActuador1 = document.getElementById("statusActuador1");
        const statusActuador2 = document.getElementById("statusActuador2");


        // --- Lógica de UI/Modales/Configuración (Original + Modificado) ---

        window.openConfig = () => configModal.classList.remove("hidden");
        window.closeConfig = () => {
            const k = localStorage.getItem("iot_api_key");
            const u = localStorage.getItem("iot_db_url");
            if (k && u) configModal.classList.add("hidden");
            else Swal.fire("Requerido", "Debes ingresar credenciales", "warning");
        };

        window.saveConfig = () => {
            const key = apiKeyInput.value.trim();
            const url = dbUrlInput.value.trim();

            if (!key || !url) return Swal.fire("Error", "Faltan datos", "error");

            localStorage.setItem("iot_api_key", key);
            localStorage.setItem("iot_db_url", url);

            Swal.fire("OK", "Conectando...", "success");
            initFirebase(key, url);
            configModal.classList.add("hidden");
        };

        function updateTemp(id, value) {
            document.getElementById(id).textContent =
                value !== undefined ? value.toFixed(1) + "°C" : "--°C";
        }

        function updateStatus(ok) {
            isConnected = ok;
            statusIndicator.innerHTML = ok
                ? `<span class="relative flex h-3 w-3">
                        <span class="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 animate-ping"></span>
                        <span class="relative inline-flex h-3 w-3 bg-emerald-500 rounded-full"></span>
                   </span>
                   <span class="text-sm text-emerald-400">Conectado a Firebase</span>`
                : `<span class="relative flex h-3 w-3">
                        <span class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 animate-ping"></span>
                        <span class="relative inline-flex h-3 w-3 bg-red-500 rounded-full"></span>
                   </span>
                   <span class="text-sm text-red-400">Desconectado</span>`;

            // Habilitar/Deshabilitar botones en modo manual según la conexión
            if (currentMode === 'manual') {
                btnActuador1.disabled = !isConnected;
                btnActuador2.disabled = !isConnected;
            }
        }

        // --- Lógica del Modo de Control (Nuevo) ---

        /**
         * Maneja el cambio de modo (Automático/Manual).
         * Si cambia a manual, solicita contraseña.
         */
        window.handleModeChange = async (newMode) => {
            if (newMode === currentMode) return;

            if (newMode === 'manual') {
                const { value: password } = await Swal.fire({
                    title: 'Acceso Manual',
                    input: 'password',
                    inputLabel: 'Contraseña para Modo Manual',
                    inputPlaceholder: 'Ingresa la contraseña...',
                    inputAttributes: {
                        maxlength: 10,
                        autocapitalize: 'off',
                        autocorrect: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true,
                });

                if (password === MANUAL_PASSWORD) {
                    // Contraseña correcta
                    currentMode = 'manual';
                    manualControlSection.classList.remove('hidden');
                    updateModeInDB('manual');
                    btnActuador1.disabled = !isConnected;
                    btnActuador2.disabled = !isConnected;
                    Swal.fire('Éxito', 'Modo Manual Activado', 'success');
                } else {
                    // Contraseña incorrecta o cancelada
                    Swal.fire('Error', 'Contraseña incorrecta o cancelada. Permaneces en Automático.', 'error');
                    controlModeSelect.value = 'automatico';
                    // No cambia currentMode, permanece en automatico
                }
            } else if (newMode === 'automatico') {
                // Cambio a Automático
                currentMode = 'automatico';
                manualControlSection.classList.add('hidden');
                updateModeInDB('automatico');
                btnActuador1.disabled = true;
                btnActuador2.disabled = true;
            }
        }

        /**
         * Escribe el nuevo modo de control en Firebase.
         */
        function updateModeInDB(mode) {
            if (!db) return Swal.fire('Error', 'No conectado a Firebase para cambiar el modo', 'error');

            const modeRef = ref(db, `${dbPath}/control_mode`);
            set(modeRef, mode)
                .then(() => {
                    console.log(`Modo de control actualizado a: ${mode}`);
                    modeStatus.textContent = mode;
                    modeStatus.className = mode === 'automatico' 
                        ? 'mt-2 text-center text-xs font-bold uppercase text-emerald-400' 
                        : 'mt-2 text-center text-xs font-bold uppercase text-yellow-400';
                })
                .catch(err => {
                    console.error('Error al escribir el modo de control:', err);
                    Swal.fire('Error de DB', 'No se pudo escribir el modo de control en Firebase.', 'error');
                });
        }

        // --- Lógica de Control de Actuadores (Nuevo) ---

        /**
         * Cambia el estado de un actuador en Firebase.
         */
        window.toggleActuador = (actuatorNumber) => {
            if (!isConnected || currentMode !== 'manual') {
                return Swal.fire('Error', 'Debe estar en Modo Manual y conectado a Firebase para controlar.', 'warning');
            }

            // Obtener estado actual del botón para determinar el nuevo estado
            const btn = actuatorNumber === 1 ? btnActuador1 : btnActuador2;
            const newState = btn.textContent.includes('Apagar') ? 1 : 0; // Si dice "Apagar" (está ON), el nuevo estado es 0 (OFF). Si dice "Encender" (está OFF), el nuevo estado es 1 (ON).

            const actuatorRef = ref(db, `${dbPath}/actuadores/actuador${actuatorNumber}`);
            
            // Escribir el nuevo estado (1 = Encendido, 0 = Apagado)
            set(actuatorRef, newState)
                .then(() => {
                    console.log(`Actuador ${actuatorNumber} actualizado a: ${newState === 1 ? 'ON' : 'OFF'}`);
                    // El estado de la UI se actualizará automáticamente con la función updateActuatorStatus
                })
                .catch(err => {
                    console.error('Error al controlar actuador:', err);
                    Swal.fire('Error de DB', 'No se pudo cambiar el estado del actuador.', 'error');
                });
        }

        /**
         * Actualiza el indicador visual y el botón de control del actuador.
         */
        function updateActuatorStatus(actuatorNumber, state) {
            const isON = state === 1;
            const btn = actuatorNumber === 1 ? btnActuador1 : btnActuador2;
            const statusIndicator = actuatorNumber === 1 ? statusActuador1 : statusActuador2;

            // Actualizar Botón
            btn.textContent = isON ? 'Apagar' : 'Encender';
            btn.className = isON
                ? 'w-full py-2 rounded-lg font-bold text-slate-100 bg-emerald-600 hover:bg-emerald-700 transition duration-150'
                : 'w-full py-2 rounded-lg font-bold text-slate-100 bg-red-600 hover:bg-red-700 transition duration-150';
            
            // Actualizar Indicador
            statusIndicator.textContent = isON ? 'Encendido' : 'Apagado';
            statusIndicator.className = isON
                ? 'mt-2 text-xs font-bold text-emerald-400'
                : 'mt-2 text-xs font-bold text-red-400';
        }


        // --- Inicialización y Observación de Firebase (Modificado) ---

        function initFirebase(apiKey, databaseURL) {
            const app = initializeApp({ apiKey, databaseURL });
            db = getDatabase(app);

            const sensoresRef = ref(db, "sensores");
            const controlRef = ref(db, dbPath); // Referencia a la raíz del control

            // 1. Lectura de Sensores y Promedio
            onValue(sensoresRef, snap => {
                const data = snap.val();
                updateStatus(true);

                if (!data) return;

                // Actualiza UI de Sensores
                updateTemp("temp1", data.temp1);
                updateTemp("temp2", data.temp2);
                updateTemp("temp3", data.temp3);
                updateTemp("temp4", data.temp4);

                // Cálculo de Promedio
                const values = [data.temp1, data.temp2, data.temp3, data.temp4]
                    .filter(v => v !== undefined && typeof v === 'number');

                const prom = values.length > 0 ? values.reduce((a,b)=>a+b,0)/values.length : 0;
                tempPromedio.textContent = prom.toFixed(1) + "°C";

            }, () => updateStatus(false)); // Callback de error/desconexión

            // 2. Lectura del Modo de Control y Actuadores
            onValue(controlRef, snap => {
                const controlData = snap.val();
                if (!controlData) {
                    // Inicializar si no existe (se puede mejorar esto en el dispositivo físico)
                    updateModeInDB('automatico');
                    updateActuatorStatus(1, 0); // Estado inicial
                    updateActuatorStatus(2, 0);
                    return;
                }

                // A. Modo de Control
                const dbMode = controlData.control_mode || 'automatico';
                currentMode = dbMode; // Sincroniza el estado local con la DB
                controlModeSelect.value = dbMode; // Sincroniza el selector
                updateModeInDB(dbMode); // Actualiza la UI de estado del modo

                // Mostrar/Ocultar control manual
                if (dbMode === 'manual') {
                    manualControlSection.classList.remove('hidden');
                    btnActuador1.disabled = !isConnected;
                    btnActuador2.disabled = !isConnected;
                } else {
                    manualControlSection.classList.add('hidden');
                    btnActuador1.disabled = true;
                    btnActuador2.disabled = true;
                }

                // B. Estado de Actuadores (Indicadores)
                if (controlData.actuadores) {
                    updateActuatorStatus(1, controlData.actuadores.actuador1);
                    updateActuatorStatus(2
